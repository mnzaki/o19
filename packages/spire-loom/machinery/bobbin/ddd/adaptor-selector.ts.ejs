<%
/**
 * Adaptor Selector Template
 * Manual composition file - one place to wire up adaptors
 */
const services = locals.services;
-%>
/**
 * Adaptor Selector
 * 
 * Manual composition of adaptors and services.
 * This is the ONE manual file that wires everything together.
 * 
 * Usage:
 *   const services = createServices(db, invoke);
 *   const bookmarkService = services.bookmark;
 * 
 * @generated by ddd-services treadle
 * @manual-update Add domain-specific logic here
 */

import type { Kysely } from 'kysely';
import type { DB } from './db/types.js';
<%_ for (const service of services) { _%>
import { <%= service.serviceName %> } from './services/gen/<%= service.entityName.toLowerCase() %>.service.gen.js';
import type { <%= service.portName %> } from './ports/gen/<%= service.entityName.toLowerCase() %>.port.gen.js';
import {
  <%= service.entityName %>KyselyAdaptor,
  <%= service.entityName %>TauriAdaptor
} from './adaptors/gen/<%= service.entityName.toLowerCase() %>.adaptor.gen.js';
<%_ } _%>

/**
 * Container for all domain services
 */
export interface Services {
<%_ for (const service of services) { _%>
  <%= service.entityName.toLowerCase() %>: <%= service.portName %>;
<%_ } _%>
}

/**
 * Create all services with their adaptors
 * 
 * @param db - Kysely database instance for read operations
 * @param invoke - Tauri invoke function for write operations
 */
export function createServices(
  db: Kysely<DB>,
  invoke: <T>(cmd: string, args?: Record<string, unknown>) => Promise<T>
): Services {
<%_ for (const service of services) { _%>
  const <%= service.entityName.toLowerCase() %>ReadAdaptor = new <%= service.entityName %>KyselyAdaptor(db);
  const <%= service.entityName.toLowerCase() %>WriteAdaptor = new <%= service.entityName %>TauriAdaptor(invoke);
<%_ } _%>

  return {
<%_ for (const service of services) { _%>
    <%= service.entityName.toLowerCase() %>: new <%= service.serviceName %>(
      <%= service.entityName.toLowerCase() %>ReadAdaptor,
      <%= service.entityName.toLowerCase() %>WriteAdaptor
    ),
<%_ } _%>
  };
}

/**
 * Singleton services instance (initialized once)
 */
let servicesInstance: Services | null = null;

/**
 * Initialize services (call once at app startup)
 */
export function initializeServices(
  db: Kysely<DB>,
  invoke: <T>(cmd: string, args?: Record<string, unknown>) => Promise<T>
): Services {
  if (!servicesInstance) {
    servicesInstance = createServices(db, invoke);
  }
  return servicesInstance;
}

/**
 * Get services instance (must call initializeServices first)
 */
export function getServices(): Services {
  if (!servicesInstance) {
    throw new Error('Services not initialized. Call initializeServices() first.');
  }
  return servicesInstance;
}
