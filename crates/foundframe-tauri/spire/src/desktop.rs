// GENERATED BY SPIRE-LOOM - DO NOT EDIT (even if LLM)
// 
// This file is automatically generated from a template.
// Changes will be overwritten on next generation.
// 
// Template: node_modules/@o19/spire-loom/machinery/bobbin/tauri/desktop.rs.ejs
// Template file: desktop.rs.ejs
// To override: Copy this template to loom/bobbin/tauri/desktop.rs.ejs
// 
// To modify the generated output, edit the template file above.
//! Desktop Platform Implementation - GENERATED by spire-loom
//!
//! On desktop, we initialize RustExternalLayer directly and call into it.

use crate::spire::platform::SpireRustExternalLayerPlatformTrait;
use crate::spire::error::{Error, Result};
use crate::spire::models::*;
use serde::de::DeserializeOwned;
use std::path::PathBuf;
use tauri::{AppHandle, Manager, Runtime, plugin::PluginApi};

// Import core traits and types needed for method implementations
use RustExternalLayer::bookmark::BookmarkStream;
use RustExternalLayer::device::NodeId;
use core::str::FromStr;

/// Initialize the desktop platform.
pub fn init<R: Runtime, C: DeserializeOwned>(
  app: &AppHandle<R>,
  _api: &PluginApi<R, C>,
) -> Result<DesktopPlatform<R>> {
  DesktopPlatform::new(app.clone())
}

/// Desktop platform implementation.
///
/// Holds the RustExternalLayer runtime and provides direct access to all operations.
pub struct DesktopPlatform<R: Runtime> {
  app_handle: AppHandle<R>,
  foundframe: std::sync::Mutex<Option<RustExternalLayer::Foundframe>>,
}

impl<R: Runtime> DesktopPlatform<R> {
  fn new(app_handle: AppHandle<R>) -> Result<Self> {
    // Initialize RustExternalLayer
    let app_data_dir = app_handle.path().app_data_dir()
      .map_err(|e| Error::Other(format!("Failed to get app data dir: {e}")))?;
    let radicle_home = app_data_dir.join(".RustExternalLayer.radicle");

    let init_options = RustExternalLayer::InitOptions::new(&radicle_home, "RustExternalLayer")
      .pkb_base(default_pkb_path());

    let foundframe = RustExternalLayer::init(init_options, None)
      .map_err(|e| Error::Other(format!("Failed to initialize RustExternalLayer: {e}")))?;

    Ok(Self { 
      app_handle,
      foundframe: std::sync::Mutex::new(Some(foundframe)),
    })
  }

  pub fn app_handle(&self) -> &AppHandle<R> {
    &self.app_handle
  }
}

fn default_pkb_path() -> PathBuf {
  PathBuf::from("pkb")
}

impl<R: Runtime> SpireRustExternalLayerPlatformTrait for DesktopPlatform<R> {
  fn exit(&self, code: i32) {
    self.app_handle.exit(code);
  }

  fn request_permissions(&self) -> Result<NotificationPermissionStatus> {
    Ok(NotificationPermissionStatus {
      status: "granted".into(),
    })
  }

  fn shutdown(&self) -> Result<()> {
    // TODO: Shutdown RustExternalLayer
    Ok(())
  }

  fn bookmark_add_bookmark(
    &self,
        url: String,
        title: Option<String>,
        notes: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_bookmark(&url, &title, &notes)
  }

  fn bookmark_get_bookmark_by_url(
    &self,
        pkb_url: String
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.get_bookmark_by_url(&pkb_url)
  }

  fn bookmark_list_bookmarks(
    &self,
        directory: Option<String>
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_bookmarks(&directory)
  }

  fn bookmark_delete_bookmark(
    &self,
        pkb_url: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.delete_bookmark(&pkb_url)
  }

  fn conversation_add_conversation(
    &self,
        conversation_id: String,
        title: Option<String>,
        participants: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_conversation(&conversation_id, &title, &participants)
  }

  fn conversation_get_conversation(
    &self,
        conversation_id: String
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.get_conversation(&conversation_id)
  }

  fn conversation_list_conversations(
    &self,
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_conversations()
  }

  fn conversation_update_conversation(
    &self,
        conversation_id: String,
        title: Option<String>,
        participants: Option<String>
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.update_conversation(&conversation_id, &title, &participants)
  }

  fn conversation_delete_conversation(
    &self,
        conversation_id: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.delete_conversation(&conversation_id)
  }

  fn conversation_add_participant(
    &self,
        conversation_id: String,
        person_handle: String,
        role: Option<String>
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_participant(&conversation_id, &person_handle, &role)
  }

  fn conversation_remove_participant(
    &self,
        conversation_id: String,
        person_handle: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.remove_participant(&conversation_id, &person_handle)
  }

  fn conversation_list_participants(
    &self,
        conversation_id: String
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_participants(&conversation_id)
  }

  fn conversation_add_conversation_media(
    &self,
        conversation_id: String,
        media_url: String,
        context: Option<String>
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_conversation_media(&conversation_id, &media_url, &context)
  }

  fn conversation_remove_conversation_media(
    &self,
        conversation_id: String,
        media_url: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.remove_conversation_media(&conversation_id, &media_url)
  }

  fn conversation_list_conversation_media(
    &self,
        conversation_id: String
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_conversation_media(&conversation_id)
  }

  fn device_generate_pairing_code(
    &self,
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.generate_pairing_code()
  }

  fn device_confirm_pairing(
    &self,
        device_id: String,
        code: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.confirm_pairing(&device_id, &code)
  }

  fn device_unpair_device(
    &self,
        device_id: String
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.unpair_device(&device_id)
  }

  fn device_list_paired_devices(
    &self,
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_paired_devices()
  }

  fn device_follow_device(
    &self,
        device_id: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.follow_device(&device_id)
  }

  fn device_unfollow_device(
    &self,
        device_id: String
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.unfollow_device(&device_id)
  }

  fn device_list_followers(
    &self,
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_followers()
  }

  fn device_is_following(
    &self,
        device_id: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.is_following(&device_id)
  }

  fn media_add_media_link(
    &self,
        url: String,
        title: Option<String>,
        mime_type: Option<String>,
        directory: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_media_link(&url, &title, &mime_type, &directory)
  }

  fn media_add_media_file(
    &self,
        file_path: String,
        title: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_media_file(&file_path, &title)
  }

  fn media_get_media_by_url(
    &self,
        url: String
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.get_media_by_url(&url)
  }

  fn media_list_media(
    &self,
        directory: Option<String>
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_media(&directory)
  }

  fn media_delete_media(
    &self,
        pkb_url: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.delete_media(&pkb_url)
  }

  fn person_add_person(
    &self,
        display_name: String,
        handle: Option<String>,
        metadata: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_person(&display_name, &handle, &metadata)
  }

  fn person_get_person_by_handle(
    &self,
        handle: String
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.get_person_by_handle(&handle)
  }

  fn person_list_people(
    &self,
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_people()
  }

  fn person_update_person(
    &self,
        handle: String,
        display_name: Option<String>,
        metadata: Option<String>
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.update_person(&handle, &display_name, &metadata)
  }

  fn person_delete_person(
    &self,
        handle: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.delete_person(&handle)
  }

  fn post_add_post(
    &self,
        content: String,
        title: Option<String>,
        tags: Option<String>
    
  ) -> () {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.add_post(&content, &title, &tags)
  }

  fn post_get_post_by_url(
    &self,
        pkb_url: String
    
  ) -> String {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.get_post_by_url(&pkb_url)
  }

  fn post_list_posts(
    &self,
        directory: Option<String>
    
  ) -> Vec<String> {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.list_posts(&directory)
  }

  fn post_update_post(
    &self,
        pkb_url: String,
        content: String,
        title: Option<String>
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.update_post(&pkb_url, &content, &title)
  }

  fn post_delete_post(
    &self,
        pkb_url: String
    
  ) -> bool {
    let guard = self.foundframe.lock().map_err(|_| Error::Other("Foundframe mutex poisoned".into()))?;
    let foundframe = guard.as_ref().ok_or_else(|| Error::Other("Foundframe not initialized".into()))?;
    
    let __service = foundframe;;
    
    // Call the implementation (non-Result, errors ignored/panics)
    __service.delete_post(&pkb_url)
  }

}
