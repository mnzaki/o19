// GENERATED BY SPIRE-LOOM - DO NOT EDIT (even if LLM)
// 
// This file is automatically generated from a template.
// Changes will be overwritten on next generation.
// 
// Template: node_modules/@o19/spire-loom/machinery/bobbin/tauri/desktop_mainline_bridge.rs.ejs
// Template file: desktop_mainline_bridge.rs.ejs
// To override: Copy this template to loom/bobbin/tauri/desktop_mainline_bridge.rs.ejs
// 
// To modify the generated output, edit the template file above.
//! Desktop Platform Bridge - GENERATED by spire-loom
//!
//! This implementation bridges the mainline Platform trait to the spire's
//! generated SpireFoundframePlatformTrait. It delegates CRUD operations to the
//! spire platform while maintaining compatibility with the mainline trait.
//!
//! NOTE: Custom methods (camera, pairing) are NOT implemented here.
//! They remain in the mainline src/desktop.rs as hand-written code.

use crate::platform::{Platform, HasEventBus, HasStream, *};
use crate::{Error, Result};
use crate::spire::platform::SpireFoundframePlatformTrait;
use crate::spire::models::*;
use o19_foundframe::signal::EventBus;
use o19_foundframe::thestream::TheStream;
use serde::de::DeserializeOwned;
use std::path::PathBuf;
use tauri::{AppHandle, Manager, Runtime, plugin::PluginApi};

/// Initialize the desktop platform bridge.
pub fn init<R: Runtime, C: DeserializeOwned>(
  app: &AppHandle<R>,
  api: &PluginApi<R, C>,
) -> Result<SpireFoundframeDesktopBridge<R>> {
  SpireFoundframeDesktopBridge::new(app.clone(), api)
}

/// Desktop platform bridge implementation.
///
/// Wraps the spire's generated platform and implements the mainline Platform trait.
/// Generated methods delegate to the spire platform.
/// Custom methods (camera, pairing) are NOT implemented - use mainline DesktopPlatform.
pub struct SpireFoundframeDesktopBridge<R: Runtime> {
  app_handle: AppHandle<R>,
  // The spire's generated platform handles all CRUD operations
  spire_platform: crate::spire::desktop::DesktopPlatform<R>,
}

impl<R: Runtime> SpireFoundframeDesktopBridge<R> {
  fn new(app_handle: AppHandle<R>, api: &PluginApi<R, impl DeserializeOwned>) -> Result<Self> {
    // Initialize the spire platform
    let spire_platform = crate::spire::desktop::init(&app_handle, api)
      .map_err(|e| Error::Other(format!("Failed to initialize spire platform: {}", e)))?;

    Ok(Self {
      app_handle,
      spire_platform,
    })
  }

  pub fn app_handle(&self) -> &AppHandle<R> {
    &self.app_handle
  }

  /// Access the underlying spire platform for direct CRUD operations.
  pub fn spire_platform(&self) -> &impl SpireFoundframePlatformTrait {
    &self.spire_platform
  }
}

// ============================================================================
// Generated Platform Trait Implementation
// ============================================================================

impl<R: Runtime> Platform for SpireFoundframeDesktopBridge<R> {
  fn event_bus(&self) -> &EventBus {
    // The spire platform doesn't expose event bus directly
    // This is a limitation - custom implementation needed for full functionality
    panic!("event_bus() not available in bridge platform - use mainline DesktopPlatform")
  }

  fn stream(&self) -> &TheStream {
    // The spire platform doesn't expose stream directly
    // This is a limitation - custom implementation needed for full functionality
    panic!("stream() not available in bridge platform - use mainline DesktopPlatform")
  }

  fn exit(&self, code: i32) {
    self.spire_platform.exit(code);
  }

  fn request_permissions(&self) -> Result<NotificationPermissionStatus> {
    self.spire_platform.request_permissions()
      .map_err(|e| Error::Other(e.to_string()))
  }

  fn shutdown(&self) -> Result<()> {
    self.spire_platform.shutdown()
      .map_err(|e| Error::Other(e.to_string()))
  }

  // ========================================================================
  // Device Pairing - NOT IMPLEMENTED (custom mainline only)
  // ========================================================================

  fn generate_pairing_qr(&self, _device_name: String) -> Result<PairingQrResponse> {
    Err(Error::Other("generate_pairing_qr not implemented in bridge platform".into()))
  }

  fn parse_pairing_url(&self, _url: String) -> Result<ScannedPairingData> {
    Err(Error::Other("parse_pairing_url not implemented in bridge platform".into()))
  }

  fn check_followers_and_pair(&self) -> Result<Vec<PairedDeviceInfo>> {
    Err(Error::Other("check_followers_and_pair not implemented in bridge platform".into()))
  }

  // ========================================================================
  // Camera Operations - NOT IMPLEMENTED (custom mainline only)
  // ========================================================================

  fn start_camera(&self, _mode: String, _camera_direction: String) -> Result<serde_json::Value> {
    Err(Error::Other("Camera not supported in bridge platform".into()))
  }

  fn stop_camera(&self) -> Result<serde_json::Value> {
    Err(Error::Other("Camera not supported in bridge platform".into()))
  }

  fn capture_photo(&self) -> Result<serde_json::Value> {
    Err(Error::Other("Camera not supported in bridge platform".into()))
  }

  fn set_camera_mode(&self, _mode: String, _camera_direction: String) -> Result<serde_json::Value> {
    Err(Error::Other("Camera not supported in bridge platform".into()))
  }

  fn is_camera_active(&self) -> Result<serde_json::Value> {
    Ok(serde_json::json!({ "active": false }))
  }

  fn request_camera_permissions(&self) -> Result<serde_json::Value> {
    Ok(serde_json::json!({ "granted": true }))
  }

  fn check_camera_permissions(&self) -> Result<serde_json::Value> {
    Ok(serde_json::json!({ "granted": true }))
  }
}

// ============================================================================
// Convenience Extension Trait
// ============================================================================

/// Extension trait for accessing spire CRUD methods through the bridge.
pub trait SpireBridgeExt<R: Runtime> {
  /// Access bookmark operations via spire platform.
  fn spire_bookmark(&self) -> &impl BookmarkOps;
  /// Access device operations via spire platform.
  fn spire_device(&self) -> &impl DeviceOps;
  /// Access media operations via spire platform.
  fn spire_media(&self) -> &impl MediaOps;
  /// Access person operations via spire platform.
  fn spire_person(&self) -> &impl PersonOps;
  /// Access post operations via spire platform.
  fn spire_post(&self) -> &impl PostOps;
  /// Access conversation operations via spire platform.
  fn spire_conversation(&self) -> &impl ConversationOps;
}

// Note: These would need actual trait definitions for BookmarkOps, etc.
// For now, users can access via spire_platform() directly.

/// Re-export the spire platform for direct access.
pub use crate::spire::desktop::DesktopPlatform as SpireDesktopPlatform;
