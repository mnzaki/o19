//! o19-foundframe-tauri - GENERATED by spire-loom
//!
//! Tauri plugin helper for foundframe platform integration.
//! 
//! Usage in your plugin:
//! ```rust
//! use tauri::plugin::{Builder, TauriPlugin};
//! 
//! pub fn init<R: Runtime>() -> TauriPlugin<R> {
//!   Builder::new("my-plugin")
//!     // Commands are auto-injected by spire-loom into generate_handler!
//!     .invoke_handler(tauri::generate_handler![my_custom_command])
//!     .setup(|app, api| {
//!       // Setup spire platform
//!       let foundframe = crate::spire::setupSpireFoundframe(app, &api)?;
//!       
//!       // Your additional setup...
//!       Ok(())
//!     })
//!     .build()
//! }
//! ```
//!
//! Muxing: This plugin supports multiple platform implementations
//! - #[cfg(desktop)] → DesktopPlatform (direct foundframe calls)
//! - #[cfg(mobile)] → MobilePlatform (JNI calls to Android service)

use serde::de::DeserializeOwned;
use std::sync::Arc;
use tauri::{
  AppHandle, Manager, Runtime,
  plugin::{Builder, TauriPlugin, PluginApi},
};
use tracing::info;

pub use self::models::*;
pub use self::platform::SpireFoundframePlatformTrait;

pub mod commands;
pub mod error;
pub mod extension;
pub mod models;
pub mod platform;

pub use extension::SpireFoundframeExt;
pub use error::{Error, Result};

/// Platform struct that contains all foundframe state.
/// 
/// This is the main handle users interact with after setup.
pub struct SpireFoundframePlatform {
  platform: Arc<dyn SpireFoundframePlatformTrait>,
}

impl SpireFoundframePlatform {
  /// Setup the platform and manage it on the app handle.
  /// 
  /// Call this from your plugin's setup function.
  pub fn setup<R: Runtime, C: DeserializeOwned>(
    app: &AppHandle<R>,
    api: &PluginApi<R, C>,
  ) -> Result<Self> {
    info!("Setting up SpireFoundframePlatform...");

    // Initialize platform implementation (muxing happens here)
    #[cfg(mobile)]
    let platform = Arc::new(mobile::init(app, api)?) as Arc<dyn SpireFoundframePlatformTrait>;
    #[cfg(desktop)]
    let platform = Arc::new(desktop::init(app, api)?) as Arc<dyn SpireFoundframePlatformTrait>;

    // Manage the platform so extension trait can access it
    app.manage(platform.clone());

    info!("SpireFoundframePlatform setup complete");
    Ok(Self { platform })
  }

  /// Get a reference to the platform implementation.
  pub fn platform(&self) -> &dyn SpireFoundframePlatformTrait {
    &*self.platform
  }
}

/// Convenience function for setup.
/// 
/// Returns the platform handle for direct access.
pub fn setupSpireFoundframe<R: Runtime, C: DeserializeOwned>(
  app: &AppHandle<R>,
  api: &PluginApi<R, C>,
) -> Result<SpireFoundframePlatform> {
  SpireFoundframePlatform::setup(app, api)
}

// ============================================================================
// Platform-specific implementations
// ============================================================================

#[cfg(desktop)]
mod desktop;
#[cfg(mobile)]
mod mobile;
